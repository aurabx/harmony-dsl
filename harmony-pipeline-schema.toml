# Harmony Proxy Pipeline Configuration Schema DSL
# This schema defines the structure and validation rules for harmony-proxy pipeline files
# It can be parsed and validated in both Rust (harmony-proxy) and PHP (runbeam cloud API)

[schema]
version = "1.7.0"
description = "Harmony Proxy pipeline configuration schema for routing and middleware chains"

# ========================================================================================
# PIPELINES TABLE - Pipeline definitions (multiple instances)
# ========================================================================================
[[table]]
name = "pipelines.*"
pattern = true
pattern_constraint = "^[a-z0-9_-]+$"
required = false
description = "Pipeline definition linking endpoints, middleware, and backends"

[[table.field]]
name = "id"
type = "string"
required = false
description = "Optional unique identifier for this pipeline"

[[table.field]]
name = "description"
type = "string"
required = false
description = "Human-readable description of this pipeline"

[[table.field]]
name = "networks"
type = "array"
required = true
array_item_type = "string"
min_items = 1
description = "List of network names this pipeline listens on"

[[table.field]]
name = "endpoints"
type = "array"
required = true
array_item_type = "string"
min_items = 1
description = "List of endpoint identifiers for this pipeline"

[[table.field]]
name = "middleware"
type = "array"
required = false
array_item_type = "string"
description = "Ordered list of middleware identifiers to apply"

[[table.field]]
name = "backends"
type = "array"
required = true
array_item_type = "string"
min_items = 1
description = "List of backend identifiers for this pipeline"

# ========================================================================================
# ENDPOINTS TABLE - Endpoint configurations (multiple instances)
# ========================================================================================
[[table]]
name = "endpoints.*"
pattern = true
pattern_constraint = "^[a-z0-9_-]+$"
required = false
description = "Endpoint configuration defining how requests are received"

[[table.field]]
name = "id"
type = "string"
required = false
description = "Optional unique identifier for this endpoint"

[[table.field]]
name = "service"
type = "string"
required = true
description = "Service type for this endpoint (must match a registered service)"

[[table.field]]
name = "peer_ref"
type = "string"
required = false
description = "Reference to a peer defined in the main config. When set, inherits the peer's connection settings as defaults."

[[table.field]]
name = "connection"
type = "table"
required = false
description = "Connection configuration for this endpoint (overrides peer_ref settings if both are specified)"

[[table.field]]
name = "connection.host"
type = "string"
required = false
description = "Hostname, IP address, or URL for this endpoint (overrides peer_ref.connection.host)"

[[table.field]]
name = "connection.port"
type = "integer"
required = false
min = 1
max = 65535
description = "Port number for this endpoint (overrides peer_ref.connection.port)"

[[table.field]]
name = "connection.protocol"
type = "string"
required = false
enum = ["http", "https", "dicom", "harmony", "fhir", "hl7v2", "custom"]
description = "Protocol type for this endpoint (overrides peer_ref.protocol)"

[[table.field]]
name = "connection.base_path"
type = "string"
required = false
description = "Base path or URL prefix for this endpoint (overrides peer_ref.connection.base_path)"

[[table.field]]
name = "authentication"
type = "table"
required = false
description = "Authentication configuration for this endpoint (overrides peer_ref settings if both are specified)"

[[table.field]]
name = "authentication.method"
type = "string"
required = false
enum = ["none", "basic", "bearer", "api_key", "mutual_tls", "custom"]
description = "Authentication method for this endpoint (overrides peer_ref.authentication.method)"

[[table.field]]
name = "authentication.credentials_path"
type = "string"
required = false
description = "Path to credentials file (overrides peer_ref.authentication.credentials_path)"

[[table.field]]
name = "options"
type = "table"
required = false
description = "Service-specific options for this endpoint"

# HTTP Service Endpoint Options
[[table.field]]
name = "options.path_prefix"
type = "string"
required = false
description = "Path prefix for HTTP endpoints"

# DICOM Service Endpoint Options
[[table.field]]
name = "options.aet"
type = "string"
required = false
description = "Application Entity Title for DICOM endpoints"

[[table.field]]
name = "options.port"
type = "integer"
required = false
min = 1
max = 65535
description = "Port for DICOM endpoints"

# ========================================================================================
# BACKENDS TABLE - Backend configurations (multiple instances)
# ========================================================================================
[[table]]
name = "backends.*"
pattern = true
pattern_constraint = "^[a-z0-9_-]+$"
required = false
description = "Backend configuration defining where requests are forwarded"

[[table.field]]
name = "id"
type = "string"
required = false
description = "Optional unique identifier for this backend"

[[table.field]]
name = "service"
type = "string"
required = true
description = "Service type for this backend (must match a registered service)"

[[table.field]]
name = "target_ref"
type = "string"
required = false
description = "Reference to a target defined in the main config. When set, inherits the target's connection settings as defaults."

[[table.field]]
name = "connection"
type = "table"
required = false
description = "Connection configuration for this backend (overrides target_ref settings if both are specified)"

[[table.field]]
name = "connection.host"
type = "string"
required = false
description = "Hostname, IP address, or URL for this backend (overrides target_ref.connection.host)"

[[table.field]]
name = "connection.port"
type = "integer"
required = false
min = 1
max = 65535
description = "Port number for this backend (overrides target_ref.connection.port)"

[[table.field]]
name = "connection.protocol"
type = "string"
required = false
enum = ["http", "https", "dicom", "harmony", "fhir", "hl7v2", "custom"]
description = "Protocol type for this backend (overrides target_ref.protocol)"

[[table.field]]
name = "connection.base_path"
type = "string"
required = false
description = "Base path or URL prefix for this backend (overrides target_ref.connection.base_path)"

[[table.field]]
name = "authentication"
type = "table"
required = false
description = "Authentication configuration for this backend (overrides target_ref settings if both are specified)"

[[table.field]]
name = "authentication.method"
type = "string"
required = false
enum = ["none", "basic", "bearer", "api_key", "mutual_tls", "custom"]
description = "Authentication method for this backend (overrides target_ref.authentication.method)"

[[table.field]]
name = "authentication.credentials_path"
type = "string"
required = false
description = "Path to credentials file (overrides target_ref.authentication.credentials_path)"

[[table.field]]
name = "timeout_secs"
type = "integer"
required = false
min = 1
max = 300
description = "Request timeout in seconds for this backend (overrides target_ref.timeout_secs)"

[[table.field]]
name = "max_retries"
type = "integer"
required = false
min = 0
max = 10
description = "Maximum retry attempts for this backend (overrides target_ref.max_retries)"

[[table.field]]
name = "options"
type = "table"
required = false
description = "Service-specific options for this backend"

# HTTP Backend Options
[[table.field]]
name = "options.path_prefix"
type = "string"
required = false
description = "Path prefix for HTTP backends"

[[table.field]]
name = "options.base_url"
type = "string"
required = false
description = "Base URL for HTTP backends"

# DICOM Backend Options
[[table.field]]
name = "options.aet"
type = "string"
required = false
description = "Remote Application Entity Title for DICOM backends"

[[table.field]]
name = "options.host"
type = "string"
required = false
description = "Remote host for DICOM backends"

[[table.field]]
name = "options.port"
type = "integer"
required = false
min = 1
max = 65535
description = "Remote port for DICOM backends"

[[table.field]]
name = "options.local_aet"
type = "string"
required = false
description = "Local Application Entity Title for DICOM SCU operations"

# ========================================================================================
# MIDDLEWARE TABLE - Middleware instance configurations (multiple instances)
# ========================================================================================
[[table]]
name = "middleware.*"
pattern = true
pattern_constraint = "^[a-z0-9_-]+$"
required = false
description = "Middleware instance configuration"

[[table.field]]
name = "id"
type = "string"
required = false
description = "Optional unique identifier for this middleware instance"

[[table.field]]
name = "type"
type = "string"
required = true
description = "Middleware type (must match a registered middleware_type)"

[[table.field]]
name = "options"
type = "table"
required = false
description = "Middleware-specific options"

# Basic Auth Middleware Options
[[table.field]]
name = "options.token_path"
type = "string"
required = false
description = "Path to token file for basic_auth middleware"

[[table.field]]
name = "options.username"
type = "string"
required = false
description = "Username for basic_auth middleware"

[[table.field]]
name = "options.password"
type = "string"
required = false
description = "Password for basic_auth middleware"

# Transform Middleware Options
[[table.field]]
name = "options.spec_path"
type = "string"
required = false
description = "Path to JOLT transform specification file for transform middleware"

[[table.field]]
name = "options.apply"
type = "string"
required = false
enum = ["left", "right", "both"]
default = "left"
description = "When to apply transform: left (request), right (response), or both"

[[table.field]]
name = "options.fail_on_error"
type = "boolean"
required = false
default = false
description = "Whether to fail the request if transform fails"

# JWT Auth Middleware Options
[[table.field]]
name = "options.issuer"
type = "string"
required = false
description = "JWT token issuer for jwtauth middleware"

[[table.field]]
name = "options.audience"
type = "string"
required = false
description = "JWT token audience for jwtauth middleware"

[[table.field]]
name = "options.trusted_issuers"
type = "array"
array_item_type = "string"
required = false
min_items = 1
description = "List of trusted JWT token issuers for validation. When specified, JWTs must have an 'iss' claim matching one of these values."

[[table.field]]
name = "options.jwks_uri"
type = "string"
required = false
description = "JWKS (JSON Web Key Set) URI for fetching public keys to verify JWT signatures (e.g., 'https://auth.example.com/.well-known/jwks.json')"

[[table.field]]
name = "options.algorithms"
type = "array"
array_item_type = "string"
required = false
min_items = 1
description = "List of allowed JWT signing algorithms (e.g., ['RS256', 'ES256']). If not specified, accepts common secure algorithms."

[[table.field]]
name = "options.required_claims"
type = "array"
array_item_type = "string"
required = false
min_items = 1
description = "List of claims that must be present in the JWT (e.g., ['sub', 'email', 'scope'])"

[[table.field]]
name = "options.leeway_seconds"
type = "integer"
required = false
default = 0
min = 0
max = 300
description = "Leeway in seconds for validating exp (expiration) and nbf (not before) claims to account for clock skew"

[[table.field]]
name = "options.validate_expiry"
type = "boolean"
required = false
default = true
description = "Whether to validate the JWT expiration (exp) claim"

# Path Filter Middleware Options
[[table.field]]
name = "options.rules"
type = "array"
array_item_type = "table"
required = false
min_items = 1
description = "Array of path filter rules. Each rule must have either 'allow' or 'deny' field (mutually exclusive). Rules are evaluated in order."

[[table.field]]
name = "options.rules.allow"
type = "string"
required = false
description = "Path pattern to allow using matchit syntax (e.g., '/ImagingStudy', '/Patient/{id}'). Mutually exclusive with 'deny'."

[[table.field]]
name = "options.rules.deny"
type = "string"
required = false
description = "Path pattern to deny using matchit syntax (e.g., '*' for deny-all). Mutually exclusive with 'allow'."

# Policies Middleware Options
[[table.field]]
name = "options.policies"
type = "array"
array_item_type = "string"
required = false
min_items = 1
description = "Array of policy IDs for the policies middleware type. Policies are defined in the top-level [policies.*] tables."

# ========================================================================================
# POLICIES TABLE - Policy definitions (multiple instances)
# ========================================================================================
[[table]]
name = "policies.*"
pattern = true
pattern_constraint = "^[a-z0-9_-]+$"
required = false
description = "Policy definitions that can be referenced by policies middleware. Each policy contains rules that define access control logic."

[[table.field]]
name = "id"
type = "string"
required = true
description = "Unique identifier for the policy (must match the table suffix)"

[[table.field]]
name = "name"
type = "string"
required = false
description = "Human-readable name for the policy"

[[table.field]]
name = "enabled"
type = "boolean"
required = false
default = true
description = "Whether this policy is enabled and should be applied"

[[table.field]]
name = "rules"
type = "array"
array_item_type = "string"
required = false
min_items = 1
description = "Array of rule IDs that this policy uses. Rules are defined in the top-level [rules.*] tables."

# ========================================================================================
# RULES TABLE - Rule definitions (multiple instances)
# ========================================================================================
[[table]]
name = "rules.*"
pattern = true
pattern_constraint = "^[a-z0-9_-]+$"
required = false
description = "Rule definitions that can be referenced by policies. Each rule defines access control logic."

[[table.field]]
name = "id"
type = "string"
required = true
description = "Unique identifier for the rule (must match the table suffix)"

[[table.field]]
name = "name"
type = "string"
required = false
description = "Human-readable name for the rule"

[[table.field]]
name = "type"
type = "string"
required = true
description = "Type of rule (e.g., 'allow_all', 'deny_all', 'ip_allow', 'ip_deny', 'rate_limit', etc.)"

[[table.field]]
name = "weight"
type = "integer"
required = false
default = 100
min = 0
max = 1000
description = "Priority weight for rule evaluation (higher values = higher priority)"

[[table.field]]
name = "enabled"
type = "boolean"
required = false
default = true
description = "Whether this rule is currently active"

[[table.field]]
name = "options"
type = "table"
required = false
description = "Rule-specific configuration options (structure depends on rule type)"

# ========================================================================================
# MIDDLEWARE_TYPES TABLE - Additional middleware type registrations (optional, for pipeline-specific types)
# ========================================================================================
[[table]]
name = "middleware_types.*"
pattern = true
pattern_constraint = "^[a-z0-9_-]+$"
required = false
description = "Additional middleware type registrations (supplements main config)"

[[table.field]]
name = "id"
type = "string"
required = false
description = "Optional unique identifier for this middleware type"

[[table.field]]
name = "module"
type = "string"
required = true
description = "Module path for this middleware type (empty string for built-in)"
